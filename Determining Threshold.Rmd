---
title: "Determining threshold: TCGA"
output: html_document
---
### Load datasets add fusion info to TCGA
Load mae objects, take complete cases
```{r, message = FALSE}
library(curatedPCaData)
TCGA <- curatedPCaData::mae_tcga
TCGA <- intersectColumns(TCGA)
```
### Subset TCGA dataset by ETS-family fusion status and compute copy number loss enrichment
Subset CNA profiles by fusion status
``` {r}
#TCGA subset
TCGA.fusion.neg <- TCGA[,TCGA$ERG_fusion_GEX==0]
TCGA.fusion.pos <- TCGA[,TCGA$ERG_fusion_GEX==1]
```
Format CNA profiles for enrichment analysis
```{r}
#Format TCGA
TCGA.fusion.pos <- as.data.frame(cbind(rownames(TCGA.fusion.pos@ExperimentList@listData$cna.gistic),
                         TCGA.fusion.pos@ExperimentList@listData$cna.gistic))
colnames(TCGA.fusion.pos)[1] <- "Hugo_Symbol"
TCGA.fusion.neg <- as.data.frame(cbind(rownames(TCGA.fusion.neg@ExperimentList@listData$cna.gistic),
                         TCGA.fusion.neg@ExperimentList@listData$cna.gistic))
colnames(TCGA.fusion.neg)[1] <- "Hugo_Symbol"
```
Compute CNA enrichment in context of ETS fusions
```{r, message=FALSE}
source("analysis scripts.R")
TCGA.loss.enrichment <- concurrent.loss.data(TCGA.fusion.neg, TCGA.fusion.pos)
```
### Calculate coverage of genes, patients, chromosomes, and bands for different p-value thresholds in TCGA ETS- patients.
Filter out genes lost in ETS+ patients
```{r, warning=FALSE}
x <- c()
ERGneg.genes <- TCGA.loss.enrichment
for (i in 1:nrow(ERGneg.genes)){
  if (ERGneg.genes$`Subset loss ratio`[i] >= ERGneg.genes$`Dataset loss ratio`[i])
  {x[i] = TRUE} else {x[i] = FALSE}
}
ERGneg.genes <- ERGneg.genes[x,]
```
Compute the coverage of ETS- patients at different p-value thresholds 
```{r, message=FALSE}
source("annotate.R")
# Initialize vector of thresholds to be tested and a summary table for reporting
# parameters for each threshold
pval.cutoff <- c(1, 0.5, 0.25, 0.1, 0.05, 0.01, 0.005, 0.0001, 0.00005, 0.00001, 0.000005, 0.000001, 0.0000001)
cutoff.table <- data.frame()
input <- annotate(ERGneg.genes[,c(1,9)])
# Iterate through vector of pval cutoffs. For each cutoff, determine:
# number of genes meeting this threshold, the number of patients harboring loss of at
# least one of these genes, the number of cytogenetic band loci over which these genes 
# are lost, and the number of chromosomes over which these genes are lost.
for (i in 1:length(pval.cutoff)){
  threshold = (input$pval <= pval.cutoff[i])
  genes <- input[threshold,]
  # Remove genes that do not meet the cutoff (j loop), and then subset patients having 
  # loss of at least one gene meeting the cutoff (k loop)
  CNA <- data.frame()
  for (j in 1:nrow(genes)){
    index <- which(genes$Hugo_Symbol[j] == TCGA.fusion.neg$Hugo_Symbol)
    CNA[j,1:ncol(TCGA.fusion.neg)] <- TCGA.fusion.neg[index,]
  }
  x <- c(TRUE)
  for (k in 2:ncol(CNA)){
    patient.CNA.profile <- CNA[k]
    if (sum((patient.CNA.profile < 0)) > 0) 
      {x[k] = TRUE} else {x[k] = FALSE}
  }
  subset <- CNA[,x]
  # Add coverage information for cutoff to summary table
  cutoff.table[i,1] <- pval.cutoff[i]
  cutoff.table[i,2] <- (ncol(subset) - 1)/(ncol(TCGA.fusion.neg)-1)
  cutoff.table[i,3] <- nrow(genes)
  cutoff.table[i,4] <- nrow(genes %>% count(Band))
  cutoff.table[i,5] <- nrow(genes %>% count(Chr))
}
colnames(cutoff.table) <- c("p-value cut-off",
                            "ratio ETS- patients covered",
                            "genes covered",
                            "cytogenetic bands covered",
                            "chromosomes covered")
```
Summary of threshold analysis:
```{r}
library(DT)
datatable(cutoff.table)
```
A p-value cutoff of <= 0.01 captures 228 loss-enriched genes that are covered by 63% of ETS- TCGA patients. These genes span 52 cytogenetic bands and 9 chromosomes. Graphical representiation of threshold analysis:
```{r}
library(ggplot2)
ggplot() +
  geom_line(data = cutoff.table, aes(x=`p-value cut-off`, y=`ratio ETS- patients covered`), color = "navy")
ggplot() +
  geom_line(data = cutoff.table, aes(x=`p-value cut-off`, y=`chromosomes covered`), color = "dark red")
```